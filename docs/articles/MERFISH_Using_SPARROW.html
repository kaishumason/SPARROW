<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsampling MERFISH Data Using SPARROW • sparrow</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Subsampling MERFISH Data Using SPARROW">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sparrow</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MERFISH_Using_SPARROW.html">Subsampling MERFISH Data Using SPARROW</a>
    </li>
    <li>
      <a href="../articles/Subsampling_Data_Using_SPARROW.html">Subsampling Data Using SPARROW</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kaishumason/SPARROW/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Subsampling MERFISH Data Using SPARROW</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/kaishumason/SPARROW/blob/HEAD/vignettes/MERFISH_Using_SPARROW.Rmd" class="external-link"><code>vignettes/MERFISH_Using_SPARROW.Rmd</code></a></small>
      <div class="hidden name"><code>MERFISH_Using_SPARROW.Rmd</code></div>

    </div>

    
    
<p>You will need the following packages</p>
<pre><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kaishumason/SPARROW" class="external-link">sparrow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre>
<div class="section level2">
<h2 id="reading-in-data">Reading in Data<a class="anchor" aria-label="anchor" href="#reading-in-data"></a>
</h2>
<p>First we read in the merfish data using the function ‘read merfish’.
This functions returns a list with the following</p>
<details><summary>
Output
</summary><ul>
<li>counts: A matrix of gene counts. Of dimension #genes (500) by #cells
n (766757)</li>
<li>regions: A vector of region ids for each cell. There are p(14)
regions.</li>
<li>CT: Cell type classification for each cell</li>
</ul></details><pre><code><span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_merfish.html">read_merfish</a></span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>We use a MERFISH colorectal cancer dataset containing 15 cell types
and 5 annotated regions. For each gene
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
we fit the model</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>i</mi><mo>,</mo><mi>g</mi></mrow></msub><mo>∼</mo><mi>P</mi><mi>o</mi><mi>i</mi><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mrow><mi>i</mi><mo>,</mo><mi>g</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y_{i,g} \sim Pois(\mu_{i,g})</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mrow><mi>i</mi><mo>,</mo><mi>g</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msubsup><mi>β</mi><msub><mi>r</mi><mi>i</mi></msub><mrow><mi>g</mi><mo>,</mo><mi>C</mi><mi>T</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msubsup></mrow><annotation encoding="application/x-tex">\log(\mu_{i,g}) = \log(L_i) + \beta^{g,CT(i)}_{r_i}</annotation></semantics></math><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>T</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">CT(i)</annotation></semantics></math>
is the cell type of cell
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>L</mi><mi>i</mi></msub><annotation encoding="application/x-tex">L_i</annotation></semantics></math>
is the library size of cell
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>r</mi><mi>i</mi></msub><annotation encoding="application/x-tex">r_i</annotation></semantics></math>
is the region that cell
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
belongs.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>β</mi><msub><mi>r</mi><mi>i</mi></msub><mrow><mi>g</mi><mo>,</mo><mi>C</mi><mi>T</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msubsup><annotation encoding="application/x-tex">\beta^{g,CT(i)}_{r_i}</annotation></semantics></math>
is the expected expression of gene
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
in cell type
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>T</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">CT(i)</annotation></semantics></math>
in region
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>r</mi><mi>i</mi></msub><annotation encoding="application/x-tex">r_i</annotation></semantics></math><br>
Then for all cell types
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>.</mi><mi>.</mi><mn>.15</mn></mrow><annotation encoding="application/x-tex">t = 1,...15</annotation></semantics></math>
and regions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>,</mo><mi>r</mi><mi>′</mi></mrow><annotation encoding="application/x-tex">r,r'</annotation></semantics></math>
we test
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub><mo>:</mo><msubsup><mi>β</mi><mi>r</mi><mrow><mi>g</mi><mo>,</mo><mi>t</mi></mrow></msubsup><mo>=</mo><msubsup><mi>β</mi><mrow><mi>r</mi><mi>′</mi></mrow><mrow><mi>g</mi><mo>,</mo><mi>t</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">H_0: \beta^{g,t}_{r} = \beta^{g,t}_{r'}</annotation></semantics></math></p>
<p>The original dataset contains approximately 800,000 cells. We will
first downsample to 300,000 cells for the sake of speed. We will then
use SPARROW to select a powerful subsample of cells that can recover the
majority of significant effects.</p>
<div class="section level3">
<h3 id="step-1-one-hot-encoding-region-and-cell-type-classification">Step 1: One hot encoding region and cell type classification<a class="anchor" aria-label="anchor" href="#step-1-one-hot-encoding-region-and-cell-type-classification"></a>
</h3>
<pre><code><span><span class="va">data</span><span class="op">$</span><span class="va">regions</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">regions</span> <span class="op">-</span> <span class="fl">1</span>, </span>
<span>                            data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>regions <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">CT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">CT</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>CT <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Sample out data to make downstream analysis faster</span></span>
<span><span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">300000</span><span class="op">]</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">counts</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span>,<span class="va">ind</span><span class="op">]</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">regions</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">[</span><span class="va">ind</span>,<span class="op">]</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">CT</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">[</span><span class="va">ind</span>,<span class="op">]</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="step-2-expand-the-covariate-matrix-to-incorporate-deconvolution">Step 2: Expand the Covariate Matrix to Incorporate
Deconvolution<a class="anchor" aria-label="anchor" href="#step-2-expand-the-covariate-matrix-to-incorporate-deconvolution"></a>
</h3>
<p>The model above has a variance covariance matrix equal to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>Z</mi><mi>T</mi></msup><mi>A</mi><mi>Z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><annotation encoding="application/x-tex">(Z^TAZ)^{-1}</annotation></semantics></math>.
The matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
is equal to
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mi>X</mi><mo>*</mo><msub><mi>λ</mi><msub><mi>t</mi><mn>1</mn></msub></msub><mo>,</mo><mi>.</mi><mi>.</mi><mi>.</mi><mi>X</mi><mo>*</mo><msub><mi>λ</mi><msub><mi>t</mi><mi>T</mi></msub></msub><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">Z = [X*\lambda_{t_1},...X*\lambda_{t_T}]</annotation></semantics></math>
i.e. we append
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
copies of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
together, weighted by the deconvolution vectors for each cell
type.<br>
The matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
is diagonal with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mrow><mi>i</mi><mo>,</mo><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">A_{i,i}</annotation></semantics></math>
approximately equal to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>i</mi></msub><msubsup><mi>β</mi><msub><mi>r</mi><mi>i</mi></msub><mi>t</mi></msubsup><mo>+</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1000</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\exp(X_i\beta_{r_i}^t + \log(1000))</annotation></semantics></math>.
As
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub><msubsup><mi>β</mi><msub><mi>r</mi><mi>i</mi></msub><mi>t</mi></msubsup></mrow><annotation encoding="application/x-tex">X_i\beta_{r_i}^t</annotation></semantics></math>
gets larger, there is more signal. Because we intend to estimate power
later, we fix a lower bound for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub><msup><mi>β</mi><mi>t</mi></msup></mrow><annotation encoding="application/x-tex">X_i\beta^t</annotation></semantics></math>
in order to place a conservative estimate on the standard error.<br>
For now,what we will do with spatial transcriptomic data is to compute
the proportion of total UMIs that come from the each gene,compute the
75th percentile of these values, then convert this into UMIs per 1000
(e.g. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><mo>*</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>−</mi><mn>5</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">1000*\exp(-5)</annotation></semantics></math>).
To expand our covariate matrix we use the “expand covariate matrix”
function which takes 6 arguments</p>
<details><summary>
Arguments
</summary><ul>
<li>X: The covariate matrix. Of dimension n by p</li>
<li>lambda: The deconvolution matrix for each spot. Of dimension n by
T</li>
<li>family: The family of the downstream glm process that one intends to
use.</li>
<li>lib size: The library size of each spot. Either a scalar or a vector
of length n</li>
<li>min reads per 1000: The minimum reads per 1000 that we want to test
for. This is only relevant for data selection later.</li>
<li>min freq: How many non-zero observations a column in the expanded
covariate matrix needs to be valid. Default is 500.</li>
</ul></details><pre><code><span><span class="co">#get gene totals and total counts</span></span>
<span><span class="va">gene_totals</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span></span>
<span><span class="va">total_UMI</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#get good cutoff value for </span></span>
<span><span class="va">cutoff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">gene_totals</span><span class="op">/</span><span class="va">total_UMI</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="co">#make expanded covariate matrix </span></span>
<span><span class="va">expanded_X</span> <span class="op">=</span> <span class="fu">sparrow</span><span class="fu">::</span><span class="fu"><a href="../reference/expand_covariate_matrix.html">expand_covariate_matrix</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">regions</span>, lambda <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">CT</span>,</span>
<span>                            family <span class="op">=</span> <span class="st">"poisson"</span>,lib_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span>,</span>
<span>                                        min_reads_per_1000 <span class="op">=</span> <span class="fl">1000</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">cutoff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">valid_cov</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">expanded_X</span>,<span class="fl">2</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">}</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">50</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">expanded_X</span> <span class="op">=</span> <span class="va">expanded_X</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">expanded_X</span>,<span class="fl">2</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">}</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">50</span><span class="op">]</span></span></code></pre>
<p>The output is a list with two entries. Valid is a matrix of dimension
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
that tells us which cell type-covariate combinations have sample size
that exceed the min frequency. X holds the expanded covariate matrix,
removing the invalid cell type-covariate combinations.</p>
</div>
<div class="section level3">
<h3 id="step-3-compute-target-standard-error-of-subsample">Step 3: Compute Target Standard Error of Subsample<a class="anchor" aria-label="anchor" href="#step-3-compute-target-standard-error-of-subsample"></a>
</h3>
<p>The goal of SPARROW is to identify a subsample of the data such that
the subsampled data and the original data have similar power. This is
done by comparing the standard errors in the subsample and the standard
errors in the original dataset. Key to this procedure is specifying a
minimum effect size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mo>min</mo></msub><annotation encoding="application/x-tex">\delta_{\min}</annotation></semantics></math>.
This is the minimum effect size that one cares about identifying.<br>
For example, in the case of poisson regression, one may not care about
identifying log fold changes less than a certain amount. In this case
let us choose
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>δ</mi><mo>min</mo></msub><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\delta_{\min} = 0.05</annotation></semantics></math>.
For covariate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
let its standard error on the entire dataset be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mi>j</mi></msub><annotation encoding="application/x-tex">\sigma_j</annotation></semantics></math>.
Under some assumptions one can compute the power when the standard error
is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mi>j</mi></msub><annotation encoding="application/x-tex">\sigma_j</annotation></semantics></math>
and the effect size is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>δ</mi><annotation encoding="application/x-tex">\delta</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>σ</mi><mi>j</mi></msub><mo>,</mo><mi>δ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(\sigma_j,\delta)</annotation></semantics></math>.
Define
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>σ</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(\sigma_j)</annotation></semantics></math>
as the average power the interval
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>δ</mi><mo>min</mo></msub><mo>,</mo><msub><mi>δ</mi><mrow><mo>max</mo><mo>,</mo><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[\delta_{\min},\delta_{\max,j}]</annotation></semantics></math>.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><annotation encoding="application/x-tex">\delta_{max}</annotation></semantics></math>
is defined as</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>δ</mi><mrow><mo>max</mo><mo>,</mo><mi>j</mi></mrow></msub><mo>=</mo><munder><mo>min</mo><mi>δ</mi></munder><mo>:</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>σ</mi><mi>j</mi></msub><mo>,</mo><mi>δ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>&gt;</mo><mn>0.999</mn></mrow><annotation encoding="application/x-tex">\delta_{\max,j} = \min_{\delta}: P(\sigma_j,\delta) &gt; 0.999</annotation></semantics></math></p>
<p>If
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>δ</mi><mrow><mo>max</mo><mo>,</mo><mi>j</mi></mrow></msub><mo>&lt;</mo><msub><mi>δ</mi><mo>min</mo></msub></mrow><annotation encoding="application/x-tex">\delta_{\max,j} &lt; \delta_{\min}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>σ</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0.999</mn></mrow><annotation encoding="application/x-tex">P(\sigma_j) = 0.999</annotation></semantics></math>.
Given
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>σ</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(\sigma_j)</annotation></semantics></math>,
we can compute
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mtext mathvariant="normal">target</mtext><mo>,</mo><mi>j</mi></mrow></msub><mo>=</mo><munder><mo>max</mo><mrow><msub><mi>σ</mi><mi>j</mi></msub><mi>′</mi></mrow></munder><mo>:</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>σ</mi><mi>j</mi></msub><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>&gt;</mo><mi>c</mi><mo>×</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>σ</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma_{\text{target},j} = \max_{\sigma_j '}:P(\sigma_j ') &gt; c\times P(\sigma_j)</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
is a constant close to 1
(e.g. 0.99).<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mrow><mtext mathvariant="normal">target</mtext><mo>,</mo><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">\sigma_{\text{target},j}</annotation></semantics></math>
represents the largest standard error at which we recover at least
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
of the power that the original data has for covariate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>.
Below we compute the target standard errors when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>=</mo><mn>0.975</mn></mrow><annotation encoding="application/x-tex">c = 0.975</annotation></semantics></math>.
To compute
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mrow><mtext mathvariant="normal">target</mtext><mo>,</mo><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">\sigma_{\text{target},j}</annotation></semantics></math>
we us the “compute target standard error” function. This takes 3
arguments</p>
<details><summary>
Arguments
</summary><ul>
<li>X: The expanded covariate matrix. Of dimension n by p</li>
<li>min effect: The smallest effect size we wish to detect</li>
<li>target power approximation: The power we wish to retain compared to
the standard error on the entire dataset be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mi>j</mi></msub><annotation encoding="application/x-tex">\sigma_j</annotation></semantics></math>
</li>
</ul></details><pre><code><span><span class="va">target_standard_errors</span> <span class="op">=</span> <span class="fu">sparrow</span><span class="fu">::</span><span class="fu"><a href="../reference/compute_target_standard_error.html">compute_target_standard_error</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">expanded_X</span>,</span>
<span>                                min_effect <span class="op">=</span> <span class="fl">0.05</span>,target_power_approx <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="step-4-subsampling-via-sparrow-2-minutes">Step 4: Subsampling via SPARROW (~2 minutes)<a class="anchor" aria-label="anchor" href="#step-4-subsampling-via-sparrow-2-minutes"></a>
</h3>
<p>SPARROW is a subsampling algorithm that attempts to minimize the
trace of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>Z</mi><mi>K</mi><mi>T</mi></msubsup><mi>A</mi><msub><mi>Z</mi><mi>K</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><annotation encoding="application/x-tex">(Z_K^TAZ_K)^{-1}</annotation></semantics></math>.
Here
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Z</mi><mi>K</mi></msub><annotation encoding="application/x-tex">Z_K</annotation></semantics></math>
is a submatrix of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
containing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>
rows. This is done via stochastic greedy selection which can identify
solutions that are at least
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mn>1</mn><mi>/</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">1-1/e</annotation></semantics></math>
efficient. A natural stopping criterion is when
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∀</mo><mi>j</mi><mo>:</mo><msqrt><msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>Z</mi><mi>K</mi><mi>T</mi></msubsup><mi>A</mi><msub><mi>Z</mi><mi>K</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>j</mi><mi>j</mi></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msubsup></msqrt><mo>&lt;</mo><msub><mi>σ</mi><mrow><mtext mathvariant="normal">target</mtext><mo>,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\forall j: \sqrt{(Z_K^TAZ_K)^{-1}_{jj}} &lt; \sigma_{\text{target},j}</annotation></semantics></math></p>
<p>Note that when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>δ</mi><mrow><mo>max</mo><mo>,</mo><mi>j</mi></mrow></msub><mo>&lt;</mo><msub><mi>δ</mi><mo>min</mo></msub></mrow><annotation encoding="application/x-tex">\delta_{\max,j} &lt; \delta_{\min}</annotation></semantics></math>,
the amount of data needed to achieve the target standard error plateaus.
This is what characterizes to the ultra scalability of SPARROW.<br></p>
<p>To run data selection we use the “data selection” function. It takes
5 arguments</p>
<details><summary>
Arguments
</summary><ul>
<li>X: The expanded covariate matrix. Of dimension p by n</li>
<li>data size: The maximum subsample size we want to take</li>
<li>min SE: A vector of the target standard errors</li>
<li>log: Logical of if we should log progress of data selection</li>
<li>period: If log is TRUE, how often we want to print progress in
iterations</li>
</ul></details><pre><code><span><span class="va">selected_indices</span> <span class="op">=</span> <span class="fu">sparrow</span><span class="fu">::</span><span class="fu"><a href="../reference/data_selection.html">data_selection</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">expanded_X</span><span class="op">)</span>,</span>
<span>                        max_data_size <span class="op">=</span> <span class="fl">300000</span>,min_standard_error <span class="op">=</span> <span class="va">target_standard_errors</span>,</span>
<span>                        log <span class="op">=</span> <span class="cn">TRUE</span>,period <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">selected_indices</span> <span class="op">=</span> <span class="va">selected_indices</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">selected_indices</span><span class="op">)</span> <span class="op">==</span> <span class="cn">F</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Cells Chosen: "</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">selected_indices</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p>The output is a vector of indices in the order they are selected.
Therefore if one initially picks a subset of size 100,000 but then wants
to downsample to 50,000 observations, they simply have to take the first
50,000 indices of the output. We see that we select around 90,00 cells,
1/3 of the original sample.</p>
</div>
<div class="section level3">
<h3 id="step-4-downstream-analysispoisson-glm">Step 4: Downstream Analysis(Poisson GLM)<a class="anchor" aria-label="anchor" href="#step-4-downstream-analysispoisson-glm"></a>
</h3>
<div class="section level4">
<h4 id="full-data-5-minutes">Full Data (~ 5 minutes)<a class="anchor" aria-label="anchor" href="#full-data-5-minutes"></a>
</h4>
<pre><code><span><span class="co">#get region on </span></span>
<span><span class="va">nregion</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">)</span></span>
<span><span class="va">nCT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">)</span></span>
<span><span class="co">#get number of genes </span></span>
<span><span class="va">ngene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span></span>
<span><span class="co">#get library size of cells </span></span>
<span><span class="va">spot_size</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span></span>
<span><span class="co">#save results to a list </span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#start time</span></span>
<span><span class="va">t1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">ngene</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span><span class="fl">100</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Iteration "</span>,<span class="va">i</span>,<span class="st">" out of "</span>,<span class="va">ngene</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">t1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">#save beta </span></span>
<span>  <span class="va">beta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">nregion</span> ,<span class="va">nCT</span><span class="op">)</span></span>
<span>  <span class="co">#get dimnames of beta </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">)</span></span>
<span>  <span class="co">#standard error matrix </span></span>
<span>  <span class="va">SE</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">nregion</span>,<span class="va">nCT</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">SE</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">SE</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">)</span></span>
<span>  <span class="co">#get counts</span></span>
<span>  <span class="va">Y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nCT</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">#get cells that correspond to that cell type</span></span>
<span>    <span class="va">cells</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="co">#get covariate matrix </span></span>
<span>    <span class="va">X</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">[</span><span class="va">cells</span>,<span class="op">]</span></span>
<span>    <span class="co">#subset covariate matrix by valid </span></span>
<span>    <span class="va">ct_ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">valid_cov</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">X</span> <span class="op">=</span> <span class="va">X</span><span class="op">[</span>,<span class="va">ct_ind</span><span class="op">]</span></span>
<span>    <span class="co">#get response </span></span>
<span>    <span class="va">y</span> <span class="op">=</span> <span class="va">Y</span><span class="op">[</span><span class="va">cells</span><span class="op">]</span></span>
<span>    <span class="co">#get offset </span></span>
<span>    <span class="va">offset_cells</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">spot_size</span><span class="op">)</span><span class="op">[</span><span class="va">cells</span><span class="op">]</span></span>
<span>    <span class="co">#fit model </span></span>
<span>    <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">X</span><span class="op">-</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">offset_cells</span><span class="op">)</span>,family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span>
<span>    <span class="co">#save beta </span></span>
<span>    <span class="va">beta</span><span class="op">[</span><span class="va">ct_ind</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>    <span class="co">#save standard errors </span></span>
<span>    <span class="va">SE</span><span class="op">[</span><span class="va">ct_ind</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">#save results </span></span>
<span>  <span class="va">res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>,SE <span class="op">=</span> <span class="va">SE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#start time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">t1</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="subsampled-data-2-minutes">Subsampled Data (~ 2 minutes)<a class="anchor" aria-label="anchor" href="#subsampled-data-2-minutes"></a>
</h4>
<pre><code><span><span class="co">#get region on </span></span>
<span><span class="va">nregion</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">)</span></span>
<span><span class="va">nCT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">)</span></span>
<span><span class="co">#get number of genes </span></span>
<span><span class="va">ngene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span></span>
<span><span class="co">#get library size of cells </span></span>
<span><span class="va">spot_size</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span></span>
<span><span class="co">#save results to a list </span></span>
<span><span class="va">res_subsample</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">ngene</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span><span class="fl">100</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Iteration "</span>,<span class="va">i</span>,<span class="st">" out of "</span>,<span class="va">ngene</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">t1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">#save beta </span></span>
<span>  <span class="va">beta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">nregion</span> ,<span class="va">nCT</span><span class="op">)</span></span>
<span>  <span class="co">#get dimnames of beta </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">)</span></span>
<span>  <span class="co">#standard error matrix </span></span>
<span>  <span class="va">SE</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">nregion</span>,<span class="va">nCT</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">SE</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">SE</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">)</span></span>
<span>  <span class="co">#get counts</span></span>
<span>  <span class="va">Y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nCT</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">#get cells that correspond to that cell type</span></span>
<span>    <span class="va">cells</span> <span class="op">=</span> <span class="va">selected_indices</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">CT</span><span class="op">[</span><span class="va">selected_indices</span>,<span class="va">j</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="co">#get covariate matrix </span></span>
<span>    <span class="va">X</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">regions</span><span class="op">[</span><span class="va">cells</span>,<span class="op">]</span></span>
<span>    <span class="co">#subset covariate matrix by valid </span></span>
<span>    <span class="va">ct_ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">valid_cov</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">X</span> <span class="op">=</span> <span class="va">X</span><span class="op">[</span>,<span class="va">ct_ind</span><span class="op">]</span></span>
<span>    <span class="co">#get response </span></span>
<span>    <span class="va">y</span> <span class="op">=</span> <span class="va">Y</span><span class="op">[</span><span class="va">cells</span><span class="op">]</span></span>
<span>    <span class="co">#get offset </span></span>
<span>    <span class="va">offset_cells</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">spot_size</span><span class="op">)</span><span class="op">[</span><span class="va">cells</span><span class="op">]</span></span>
<span>    <span class="co">#fit model </span></span>
<span>    <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">X</span><span class="op">-</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">offset_cells</span><span class="op">)</span>,family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span>
<span>    <span class="co">#save beta </span></span>
<span>    <span class="va">beta</span><span class="op">[</span><span class="va">ct_ind</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>    <span class="co">#save standard errors </span></span>
<span>    <span class="va">SE</span><span class="op">[</span><span class="va">ct_ind</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">#save results </span></span>
<span>  <span class="va">res_subsample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>,SE <span class="op">=</span> <span class="va">SE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="recall-plot-contrast-test">Recall Plot: Contrast Test<a class="anchor" aria-label="anchor" href="#recall-plot-contrast-test"></a>
</h3>
<div class="section level4">
<h4 id="compute-contrast-test-scores">Compute contrast test scores<a class="anchor" aria-label="anchor" href="#compute-contrast-test-scores"></a>
</h4>
<pre><code><span><span class="va">contrast_test</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta</span>,<span class="va">SE</span>,<span class="va">upper</span> <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">pvals</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">diff</span> <span class="op">=</span> <span class="va">beta</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">-</span> <span class="va">beta</span></span>
<span>      <span class="va">diff_SE</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">SE</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">SE</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="va">pvals</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff</span><span class="op">/</span><span class="va">diff_SE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">upper</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">pvals</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">pvals</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">pvals</span><span class="op">)</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">pvals</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="co">#get pvalue list for full data and subsampled data </span></span>
<span><span class="va">pvalue_subsample</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pvalue_full</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">ngene</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">full_result</span> <span class="op">=</span> <span class="va">res</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">subsample_result</span> <span class="op">=</span> <span class="va">res_subsample</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">nCT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">full_result</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nCT</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">p_sub</span> <span class="op">=</span> <span class="fu">contrast_test</span><span class="op">(</span><span class="va">full_result</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span>,<span class="va">k</span><span class="op">]</span>,<span class="va">full_result</span><span class="op">$</span><span class="va">SE</span><span class="op">[</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">p_full</span> <span class="op">=</span> <span class="fu">contrast_test</span><span class="op">(</span><span class="va">subsample_result</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span>,<span class="va">k</span><span class="op">]</span>,<span class="va">subsample_result</span><span class="op">$</span><span class="va">SE</span><span class="op">[</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">pvalue_subsample</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pvalue_subsample</span>,<span class="va">p_sub</span><span class="op">)</span></span>
<span>    <span class="va">pvalue_full</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pvalue_full</span>,<span class="va">p_full</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">pvalue_subsample_adj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html" class="external-link">p.adjust</a></span><span class="op">(</span><span class="va">pvalue_subsample</span>, method <span class="op">=</span> <span class="st">"BH"</span><span class="op">)</span></span>
<span><span class="va">pvalue_full_adj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html" class="external-link">p.adjust</a></span><span class="op">(</span><span class="va">pvalue_full</span>, method <span class="op">=</span> <span class="st">"BH"</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="compute-and-plot-recall">Compute and Plot Recall<a class="anchor" aria-label="anchor" href="#compute-and-plot-recall"></a>
</h4>
<p>We now adjust our pvalues using the BH procedure and compute the
recall, assuming that the results from the full data model are the
truth, across a variety of qvalue cutoffs. The x-axis shows the qvalue
cutoff that would be used on the original dataset. The y-axis shows the
recall on the subsetted dataset if the qvalue cutoff was 0.05. We see
that the recall is nearly perfect no matter what qvalue cutoff is
chosen. That is that a standard analysis with 1/3 of the data can
identify nearly all effects found in the full dataset.</p>
<pre><code><span><span class="va">CT_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">res</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">1000</span>,<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pvalue_full_adj</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">pvalue_full_adj</span><span class="op">)</span><span class="op">==</span><span class="cn">F</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">110</span><span class="op">)</span></span>
<span><span class="va">Nind</span> <span class="op">=</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="va">Nindices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">N</span>,length.out <span class="op">=</span> <span class="va">Nind</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ordered_pvals</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">pvalue_full_adj</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">pvalue_full_adj</span><span class="op">)</span><span class="op">==</span><span class="cn">F</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">ordered_pvals</span> <span class="op">=</span> <span class="va">ordered_pvals</span><span class="op">[</span><span class="va">ordered_pvals</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span></span>
<span><span class="va">pval_inds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ordered_pvals</span><span class="op">)</span><span class="op">)</span>,<span class="va">N</span><span class="op">-</span><span class="fl">1</span>,replace <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">log_p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">pvalue_full_adj</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">pvalue_full_adj</span><span class="op">)</span><span class="op">==</span><span class="cn">F</span><span class="op">]</span>,<span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">log_p</span> <span class="op">=</span> <span class="va">log_p</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.infinite</a></span><span class="op">(</span><span class="va">log_p</span><span class="op">)</span> <span class="op">==</span> <span class="cn">F</span><span class="op">]</span></span>
<span><span class="va">min_log_p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">log_p</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#get numerator and denominator in recall</span></span>
<span><span class="va">recall</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">Nind</span><span class="op">)</span></span>
<span><span class="va">NUM</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">Nind</span><span class="op">)</span></span>
<span><span class="va">DEN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">Nind</span><span class="op">)</span></span>
<span><span class="va">C</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">Nind</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Nind</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#get cutoff value </span></span>
<span>  <span class="va">cutoff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">log_p</span><span class="op">)</span>,<span class="va">ordered_pvals</span><span class="op">[</span><span class="va">pval_inds</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">standard_sig</span> <span class="op">=</span> <span class="op">(</span><span class="va">pvalue_full_adj</span> <span class="op">&lt;=</span> <span class="va">cutoff</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">pvalue_subsample_adj</span><span class="op">)</span> <span class="op">==</span> <span class="cn">F</span><span class="op">)</span></span>
<span>  <span class="va">query_sig</span> <span class="op">=</span> <span class="op">(</span><span class="va">pvalue_subsample_adj</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">NUM</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">standard_sig</span> <span class="op">*</span> <span class="va">query_sig</span>,na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="va">DEN</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">standard_sig</span>,na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="va">recall</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span> <span class="va">NUM</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">/</span><span class="va">DEN</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span>  <span class="va">C</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">cutoff</span>,<span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.infinite</a></span><span class="op">(</span><span class="va">C</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">C</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">log_p</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span>  <span class="co"># Example data</span></span>
<span>  <span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    C <span class="op">=</span> <span class="va">C</span>,                <span class="co"># Replace with your actual 'C' values</span></span>
<span>    recall <span class="op">=</span> <span class="va">recall</span> <span class="co"># Replace with your actual 'recall' values</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create the plot</span></span>
<span>  <span class="va">PLOT</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">C</span>, y <span class="op">=</span> <span class="va">recall</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Scatter points</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>   <span class="co"># Optional: Connect points with lines</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>      limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,            <span class="co"># Set y-axis limits</span></span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="co"># Add y-axis ticks</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Use a clean theme</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="st">"Full Data Log Q-value Cutoff"</span>,          <span class="co"># Label for the x-axis</span></span>
<span>      y <span class="op">=</span> <span class="st">"Recall"</span>,     <span class="co"># Label for the y-axis</span></span>
<span>      title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Recall of Subsetted Data: "</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span>, <span class="co"># Add a grid</span></span>
<span>      panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>                 <span class="co"># Optional: Hide minor grids</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">PLOT</span><span class="op">)</span></span>
<span>  </span>
<span></span></code></pre>
<pre><code><span><span class="co">#compute type 1 error </span></span>
<span><span class="va">standard_null</span> <span class="op">=</span> <span class="op">(</span><span class="va">pvalue_full_adj</span> <span class="op">&gt;</span> <span class="fl">0.05</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">pvalue_subsample_adj</span><span class="op">)</span> <span class="op">==</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">query_sig</span> <span class="op">=</span> <span class="op">(</span><span class="va">pvalue_subsample_adj</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">type_1_error</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">query_sig</span> <span class="op">*</span> <span class="va">standard_null</span>,na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">standard_null</span>,na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#print </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Type 1 error rate: "</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">type_1_error</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Kaishu Mason, Yijia Jiang, Nancy R. Zhang.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
